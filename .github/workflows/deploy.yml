name: Deploy to VPS

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: aprapr/gemfund
  DOCKER_TAG: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    name: Build and Push Docker Image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to VPS
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Navigate to app directory
            mkdir -p /opt/gemfund
            cd /opt/gemfund

            # Create .env.prod
            cat > .env.prod << 'EOF'
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
            SUPABASE_JWT_SECRET=${{ secrets.SUPABASE_JWT_SECRET }}
            SUPABASE_BUCKET_NAME=${{ secrets.SUPABASE_BUCKET_NAME }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            EOF

            # Create SSL directory and certificates
            mkdir -p ssl
            cat > ssl/apir.live.pem << 'CERTEOF'
            ${{ secrets.SSL_CERT }}
            CERTEOF
            cat > ssl/apir.live.key << 'KEYEOF'
            ${{ secrets.SSL_KEY }}
            KEYEOF
            chmod 600 ssl/apir.live.key

            # Create docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            services:
              app:
                image: aprapr/gemfund:latest
                container_name: gemfund-app
                restart: unless-stopped
                env_file:
                  - .env.prod
                expose:
                  - "3000"
                networks:
                  - gemfund-network

              nginx:
                image: nginx:alpine
                container_name: gemfund-nginx
                restart: unless-stopped
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
                  - ./ssl:/etc/nginx/ssl:ro
                depends_on:
                  - app
                networks:
                  - gemfund-network

            networks:
              gemfund-network:
                driver: bridge
            EOF

            # Create nginx config with SSL
            mkdir -p nginx
            cat > nginx/nginx.conf << 'EOF'
            events {
                worker_connections 1024;
            }

            http {
                upstream app {
                    server app:3000;
                }

                server {
                    listen 80;
                    server_name gemfund.apir.live;
                    return 301 https://$server_name$request_uri;
                }

                server {
                    listen 443 ssl;
                    server_name gemfund.apir.live;

                    ssl_certificate /etc/nginx/ssl/apir.live.pem;
                    ssl_certificate_key /etc/nginx/ssl/apir.live.key;
                    ssl_protocols TLSv1.2 TLSv1.3;
                    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
                    ssl_prefer_server_ciphers off;

                    location / {
                        proxy_pass http://app;
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection 'upgrade';
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_cache_bypass $http_upgrade;
                        proxy_read_timeout 300s;
                        proxy_connect_timeout 75s;
                    }
                }
            }
            EOF

            # Pull and deploy
            docker compose pull
            docker compose up -d --remove-orphans

            # Cleanup old images
            docker image prune -f
